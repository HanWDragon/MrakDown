# 字节码整体结构

![](image/Pasted%20image%2020220504132842.png)

![](image/Pasted%20image%2020220504133040.png)

![](image/Pasted%20image%2020220504103815.png)


使用 `javap -verbose` 命令分析一个字节码文件时，将会分析字节码文件的魔数、版本号、常量池、类信息、类的构造方法、类的方法信息、类变量、成员变量等信息。
- 魔数：所有的 `.class` 字节码文件的前四个字节都是魔数，为固定值：`0xCAFEBABE`
- 魔数之后的 4 个字节为版本信息，前两个字节表示 `minor version` （次版本号），后两个字节表示 `major version` （主版本号）
- 常量池（constant pool）：紧接着主版本号之后的就是常量池入口。一个 Java 类定义的很多信息都是由常量池来维护和描述的，这里可以将常量池看作是 Class 文件的资源仓库，比如说Java类中定义的方法、变量信息，都是储存在常量池当中的。常量池中主要存储的两类常量：字面量、符号引用。字面量如文本字符串，Java中声明为final的常量值等，而符号引用如类、接口的全限定名，字段的名称和描述符，方法的名称和描述符等
- 常量池的总体结构：Java 类所对应的常量池主要由常量池数量和常量池数组（常量表）这两部分共同构成。常量池数量紧跟在主版本号之后，占据两个字节。常量池数组则紧跟在常量池数量之后，常量池数组与一般的数组不同的是，常量池数组中不同的元素类型、结构都是不同的，长度当然也不同；但是，每一个元素的第一个的数据都是一个 u1 类型，该字节是一个标志位，占据一个字节。JVM 在解析常量池时，会根据这个 u1 类型来获取元素的具体类型。值得注意的是，常量池数组中元素的个数 = 常量池数 - 1 （其中 0 暂不使用），目的是为了满足某些常量池索引的数据在特定情况下表达「不需要引用任何一个常量池」的含义；根本原因在于，索引为 0 也是一个常量（保留常量），只不过它不位于常量表中，这个常量对应的就是 null 值；所以常量池的索引从 1 开始而不是从 0 开始

![](image/Pasted%20image%2020220504103815.png)

- 在 JVM 规范中，每个变量/字段都有描述信息，描述信息主要的作用是描述字段的数据类型、方法的参数列表（包括数量、类型、顺序）和返回值。根据描述符规则，基本类型和代表无返回值的 void 类型都用一个大写字符表示，对象类型则使用字符 L 加上对象的全限定名来表示。为了压缩字节码文件的体积，对于基本数据类型，JVM都只使用一个大写字母表示，如下所示：`B -> byte, C -> char, D -> double, F-> float, I -> int, J -> long, S -> short, Z -> boolean, V -> void, L -> 对象类型，如 Ljava/lang/String;`
- 对于数组类型来说，每一个维度使用一个前置的 `[` 来表示，如 `int[]` 被记录为 `[I` ，`String[][]` 被记录为 `[[Ljava/lang/String;` 
- 用描述符描述方法时，按照先参数列表，后返回值的顺序来描述。参数列表按照参数的严格顺序放在一组 `()` 之内，如方法：`String getNameByIdAndNickname(int id, String name)` 的描述符为：`(I,Ljava/lang/String;)Ljava/lang/String;` 