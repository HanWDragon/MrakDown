# 通过本文你可以学到

- 系统设计中常说的 Tradeoff 是什么  
- 什么叫做 SOA (Service Oriented Architecture)  
- 什么是 Pull Model & 什么是 Push Model
- 数据存储系统有哪些，什么样的数据适合存在什么样的数据存储系统中
- 什么是异步任务和消息队列 (Message Queue)  
- 什么是数据的可持久化 (Persistent)  
- 什么是去标准化 (Denormalize)  
- 什么是惊群效应 (Thundering Herd)  
- 有哪些与 News Feed 类似的系统设计问题?

# 系统设计面试的形式及常见的系统设计面试问题  

- 面试的形式来说，和我们的算法面试和编程面试有很大的区别，就是题目描述非常的简短。通常都是十分开放的话题，题目的要求很少，这就要求面试者具备和面试官交流的能力
- 当你经验不太丰富时，还有一种更加具体的形式就是叫你设计某某系统中的某某功能

## 设计某某系统 Design XXX System 
- 设计微博 Design Twitter  
- 设计人人 Design Facebook  
- 设计滴滴 Design Uber
- 设计微信 Design Whatsapp  
- 设计点评 Design Yelp  
- 设计短网址系统 Design Tiny URL
- 设计NoSQL数据库 Design NoSQL

## 设计某某系统中的某某功能  
- 设计一个功能实现对用户访问频率的限制  
- 设计一个功能实现统计某个具体事件的历史发生次数
- 设计删除一个Tweet的功能  
- 设计邮件系统中将所有邮件标记为已读的功能

# 系统设计与面向对象设计的异同

## 形式上

- 面向对象
	- 设计手把手的 Coding 
- 系统设计
	- 高屋建瓴的“扯淡”

## 考察的知识点上  

- 面向对象设计
	- Class
	- Object
	- Method
	- Inheritance
	- Interface ...`
- 系统设计考的是
	- Database
	- Schema
	- SQL
	- NoSQL
	- Memcached
	- File System
	- Distributed System
	- Latency, Scalbility
	- Master Slave
	- Load Balancer
	- Web Server
	- Message Queue
	- Sharding, Consistent Hashing
	- QPS ...`

 ## 典型题
 
 - 面向对象设计
	 - 电梯设计
	 - 游戏设计
 - 系统设计
	 - 短网址系统设计
	 - 新鲜事系统设计

# Interviewer: Please design twitter

## 系统设计面试的常见错误  

- 当你拿到这个问题的时候，你该对面试官说些什么，很多人一上来就是，关键词大师，给出一大堆关键词，但是考虑了其他的因素了吗？没有明确的需求，系统设计往往都是失败的

![](image/Pasted%20image%2020221004170952.png)

- 所以，第一步都是和面试官去沟通，去细化这个问题，给出自己的解决方案

## 系统设计面试的评分标准

- 为了在系统设计这一个环节中，得到面试官更好的评价，我们到底要在面试中展现出一些什么东西，如下图
	1. 你是否提出了一个可行解，针对面试官的问题
	2. 你提出来的一个大框架，时候能解决在这个领域中的一些特定问题
	3. 在这个过程中，面试官不断的给你提出问题，你不断的通过逻辑分析解决的能力
	4. 你在面对多个方式时，你如何让效益最大化，或者什么情况下 A 好，什么情况下 B 好
	5. 知识储备是真的很难通过背八股文解决的，这真的就是自己的硬实力，光看书是虚的，动起手来，实战很重要

![](image/Pasted%20image%2020221004171210.png)

# 系统设计的九阴真经 - 4S 分析法  

- **Scenario**
- **Service** 
- **Storage**
- **Scale**

![](image/Pasted%20image%2020221004172232.png)

## Scenario 场景

- 需要设计哪些功能，设计得多牛
	1. Ask问面试官  
	2. Analysis分析

### Ask

- 询问面试官
	- 需要设计哪些功能(也可以自己想)
	- 需要承受多大的访问量?
		- 日活跃用户 Daily Active Users (DAU)
		- Twitter: MAU 330M, DAU ~170M+

#### MAU

- Monthly Active Users 衡量网站用户数的重要指标
- 一般不是用注册用户，而是用月活跃用户来代表一个网站的用户数

### 需要设计哪些功能

####  Step 1 Enumerate

- 说人话:把Twitter的功能一个个罗列出来 
-   Register / Login
-   User Profile Display / Edit
-   Upload Image / Video *
-   Search *
-   Post / Share a tweet
-   Timeline / News Feed
-   Follow / Unfollow a user

#### Step 2 Sort
    
- 说人话:选出核心功能，因为你不可能这么短的时间什么都设计
- Post a Tweet
- Timeline
- News Feed
- Follow / Unfollow a user
- Register / Login

### Analysis & Predict

![](image/Pasted%20image%2020221005172221.png)

#### 分析出 QPS 有什么用

- QPS = 100  
	- 用你的笔记本做 Web 服务器就好了
- QPS = 1k
	- 用一台好点的 Web 服务器就差不多了
	- 需要考虑 Single Point Failure 
-   QPS = 1m
	- 需要建设一个1000台 Web 服务器的集群
	- 需要考虑如何 Maintainance(某一台挂了怎么办) 
-   QPS和 Web Server (服务器) / Database (数据库) 之间的关系
	- 一台 Web Server 约承受量是 1k 的 QPS (考虑到逻辑处理时间以及数据库查询的瓶颈)
	- 一台 SQL Database 约承受量是 1k 的 QPS(如果 JOIN 和 INDEX query比较多的话，这个值会更小)
	- 一台 NoSQL Database (Cassandra) 约承受量是 10k 的 QPS
	- 一台 NoSQL Database (Memcached) 约承受量是 1M 的 QPS
	- 实际上的数据只会比这个更少，在处理一些复杂逻辑时，Web Server 可能 QPS 只有几十

## Service 服务

- 大系统拆分为小服务
	1. Replay重放需求 
	2. Merge归并需求

### 将大系统拆分为小服务

![](image/Pasted%20image%2020221005173319.png)

#### Step 1 Replay

- 重新过一遍每个需求，为每个需求添加一个服务

#### Step 2 Merge

- 归并相同的服务

#### 什么是服务 Service?  

- 可以认为是逻辑处理的整合  
- 对于同一类问题的逻辑处理归并在一个Service中
- 把整个System细分为若干个小的Service

## Storage 存储

### 数据如何存储和访问

![](image/Pasted%20image%2020221004173319.png)

![](image/Pasted%20image%2020221004175103.png)

#### 文件系统和数据库系统

##### 关系

- 数据库系统是文件系统的一层包装，他们不是独立的关系，是依赖的关系。
- 数据库系统依赖于文件系统。

##### 区别

- 数据库系统提供了更丰富的数据操作，很细。
- 文件系统只提供了简单的文件操作接口，很粗。 
- 以关系型数据库(Relational Database) 为例，提供了 SQL 语句这样的丰富的查询语言，可以一些复杂的 filter，如快速找出学生信息表中，所有 20-24 岁的学生信息。
- 如果直接在文件系统上，则需要 扫描完所有的学生数据后才能找到。
- 数据库系统中读取的数据，大部分情况下(除了被 cache 的)，都还是会到文件系统上去读取出来的，因此两个系统的读写效率(不考虑复杂查询)可以认为是差不多的。

### Interviewer: Please design schema

- 主键，通常都是业务无关的

![](image/Pasted%20image%2020221004181023.png)

### Interviewer: News Feed 如何存取

#### 什么是新鲜事 News Feed? 

- 你登陆 Facebook / Twitter / 朋友圈 之后看到的信息流
- 你的所有朋友发的信息的集合

 #### 有哪些典型的新鲜事系统?

-   Facebook
-   Twitter
-   朋友圈
-   RSS Reader

#### 新鲜事系统的核心因素

- 关注与被关注
- 每个人看到的新鲜事都是不同的

### Pull Model

- Pull = 主动撩Ta

#### 算法

- 在用户查看News Feed时，获取每个好友的前100条Tweets，合并出前100条News Feed
	- K路归并算法 Merge K Sorted Arrays

#### 复杂度分析  
- News Feed => 假如有N个关注对象，则为N次DB Reads的时间 + N路归并时间(可忽略)
	- 为什么K路归并的时间可以忽略？
- Postatweet=>1次DBWrite的时间

#### 原理图

![](image/Pasted%20image%2020221004223706.png)

#### Interviewer: Pull模型有什么缺陷么

![](image/Pasted%20image%2020221004223959.png)

### Push Model

- Push = 坐等被撩

#### 算法  

- 为每个用户建一个List存储他的News Feed信息  
- 用户发一个Tweet之后，将该推文逐个推送到每个用户的News Feed List中
	- 关键词:Fanout（写扩散）
- 用户需要查看News Feed时，只需要从该News Feed List中读取最新的100条即可

#### 复杂度分析  

- NewsFeed -> 1次DBRead  
- Postatweet -> N个粉丝，需要 N 次DBWrites
	- 好处是可以用异步任务在后台执行，无需用户等待

#### 例子

![](image/Pasted%20image%2020221005081801.png)

![](image/Pasted%20image%2020221005084619.png)

- 这个表最好建立联合索引，将 `owner_id` 和 `created_at` 进行联合索引，这样查询速度最快。

#### 原理图

![](image/Pasted%20image%2020221005091954.png)

#### Interviewer: Push模型有什么缺陷

![](image/Pasted%20image%2020221005092116.png)

### Pull 和 Push 那个更好

#### 热门Social App的模型  

- Facebook
	- Pull  
- Instagram
	- Push+Pull
- Twitter
	- Pull  
- 朋友圈
	- Push

- 像 FaceBook 和 Instagram 会对你的信息流进行排序，不是单纯的按照时间进行排序。
- 但是朋友圈就是线性浏览，顶多有一些广告插入
- 你觉得广告的插入是一个什么模型
	- 是 Pull 模型，不能是Push模型，因为广告商会对受众进行编辑，而且广告浏览次数也需要优化，不是一个线性体验

#### 误区  

- 不坚定想法，摇摆不定  
- 不能表现出Tradeoff的能力
- 无法解决特定的问题

## Scale 扩展

How to Scale? 系统如何优化与维护
1. Optimize优化  
2. Maintenance维护

### Step 1 Optimize

- 解决设计缺陷 Solve Problems
	- Pull vs Push
- 更多功能设计 More Features
	- Like, Follow & Unfollow, Ads
- 一些特殊情况 Special Cases
	- 鹿晗关晓彤搞挂微博,僵尸粉

### Step 2 Maintenance

- 鲁棒性 Robust  
	- 如果有一台服务器/数据库挂了怎么办
- 扩展性 Scalability  
	- 如果有流量暴增，如何扩展

### 解决 Pull 的缺陷

- 最慢的部分发生在用户读请求时(需要耗费用户等待时间)
	- 在DB访问之前加入Cache
	- Cache 每个用户的 Timeline
	    - N次DB请求 → N次Cache请求 (N是你关注的好友个数)
	    - Trade off → Cache所有的? Cache最近的1000条?
    - Cache 每个用户的 News Feed
	    - 没有Cache News Feed的用户
		    - 归并N个用户最近的100条Tweets，然后取出结果的前100条
	    - 有Cache News Feed的用户
		    - 归并N个用户的在某个时间戳之后的所有Tweets
        
- 对比MySQL 和 Memcached 的 QPS
	- Memcached QPS / MySQL QPS ~ 100 ~ 1000

### 解决 Push 的缺陷

- 浪费更多的存储空间 Disk  
	- 与Pull模型将News Feed存在内存(Memory)中相比  
	- Push模型将NewsFeed存在硬盘(Disk)里完全不是个事儿
	- Disk is cheap
- 不活跃用户 Inactive Users  
	- 粉丝排序 Rank followers by weight (for example, last login time)
- 粉丝数目 followers >> 关注数目 following
	- LadyGaga问题（用亿来算的用户）
	- 无解?完全切换回Pull?  
	- Tradeoff:Pull + Push vs Pull

#### Lady Gaga 问题

- 粉丝 Followers 80 M
	- Justin Bieber 95M on Instagram
	- 谢娜 100M on Weibo
- Push的挑战  
	- Fanout的过程可能需要几个小时!
- 面试时错误的回答方案  
	- 既然Push不行，那我们就切换到Pull
		- 说起来好容易啊! 
- 正确的思路
	- 尝试在现有的模型下做最小的改动来优化  
		- 比如多加几台用于做Push任务的机器，ProblemSolved!
	- 对长期的增长进行估计，并评估是否值得转换整个模型

### Push 结合 Pull 的优化方案  

- 普通的用户仍然 Push  
- 将 Lady Gaga 这类的用户，标记为明星用户  
- 对于明星用户，不 Push 到用户的 News Feed 中  
- 当用户需要的时候，来明星用户的 Timeline 里取，并合并到 News Feed 里

### 如何定义明星

- 单纯的用 followers > 1m 是否有问题？

![](image/Pasted%20image%2020221005181553.png)

- 是不是明星不能在线动态计算，要离线计算  
	- 为User增加一个is_superstar的属性  
	- 一个用户被标记为superstar之后，就不能再被取消标记

![](image/Pasted%20image%2020221005181742.png)

### Pull vs Push

- 为什么既然大家都用Pull，我们仍然要学习Push?  
	- 系统设计不是选择一个最好的方案  
	- 而是选择一个最合适的方案  
	- 如果你没有很大的流量，Push是最经济最省力的做法
- 系统设计面试也并不是期望你答出最优的解决方法，而是从你的分析当中判断你对系统的理解和知识储备。
- 什么时候用 Push?
	- 资源少
	- 想偷懒，少写代码  
	- 实时性要求不高  
	- 用户发帖比较少  
	- 双向好友关系，没有明星问题(比如朋友圈)
- 什么时候用Pull ?
- 资源充足
- 实时性要求高
- 用户发帖很多
- 单向好友关系，有明星问题

### 通用问题 Common Questions

- 数据库服务器挂了怎么办?How to maintenance?
- 用户逐渐增多了怎么办?How to scale?
	- 服务器顶不住压力怎么办?  
	- 数据库顶不住压力怎么办?
- 以上两个问题，在后文的专题中涉及!

## 总结

- 用过前3个步骤的分析，我们已经得到了一个可行方案

### Scenario场景  

- 和面试官讨论
- 搞清楚需要设计哪些功能  
- 并分析出所设计的系统大概所需要支持的 
	- Concurrent Users
	- QPS
	- Memory
	- Storage 等

### Service服务  

- 合并需要设计功能，相似的功能整合为一个Service

### Storage存储  

- 对每个Service选择合适的存储结构
- 细化数据表单  
- 画图展示数据存储和读取的流程

### 总结

- 得到一个 Work Solution 而不是 Perfect Solution
- 这个Work Solution 可以存在很多待解决的缺陷

# 系统设计面试总结

![](image/Pasted%20image%2020221005182927.png)

![](image/Pasted%20image%2020221005182939.png)

![](image/Pasted%20image%2020221005182948.png)

![](image/Pasted%20image%2020221005182959.png)

![](image/Pasted%20image%2020221005183010.png)