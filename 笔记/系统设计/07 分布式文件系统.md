# 什么是分布式系统

- 一言以概之
	- 用多台机器去解决一台机器上不能够解决的问题
- 比如
	- 存储不够
	- QPS太大

# Overview 谷歌三剑客

- Distributed File System (Google File System)
	- 怎么有效存储数据? 
	- NoSQL底层需要一个文件系统
- Map Reduce  
	- 怎么快速处理数据
- Bigtable = No-SQL DataBase
	- 怎么连接底层存储和上层数据

# Design Distributed File System

- 了解分布式文件系统后可以做什么?

- Google，Microsoft面试可能会考到
- 学习经典系统，对其他系统设计也有帮助
	- 比如如何处理 failure 和 recovery

- 对于 HDFS 和 GFS，都是差不多的架构，所以本文着重讲 GFS

# Scenario 场景分析

- 需要设计哪些功能

## 需求 1

- 用户写入一个文件，用户读取一个文件
- 支持多大的文件？
	- 越大越好？比如 > 1000T

## 需求 2

- 多台机器存储这些文件
- 支持多少台机器？
	- 越多越好？

# Service 服务

- Client + Server

## 多台机器怎么沟通

- 社会主义 or 资本主义

![](image/Pasted%20image%2020221021174918.png)

![](image/Pasted%20image%2020221021174932.png)

- Peer 2 Peer
	- Advantage
		- 一台机器挂了还可以工作
	- Disadvantage
		- 多台机器需要经常通信保持他们数据一致
    
- Master Slave  
	- Advantage
		- Simple Design
		- 数据很容易保持一致
	- Disadvantage
		- 单master要挂

- Final Decision
	- Master + Slave
	- 单master挂了重启就是。挂的概率在0.1%

# Storage 存储

- 数据如何存储

- 大文件存在哪？
	- 内存还是硬盘
	- 答案肯定是硬盘了，价格问题
- 怎么存在文件系统里面呢？
	- 怎么设计GFS

## Interviewer: How to save a file in one machine

- 普通的操作系统是怎么做的呢
- 对于一个100G的文件

### 一个文件有什么东西

- 文件本身包含的数据
- 文件的修改时间
- 文件名
- 文件的格式
- 文件的大小
- 这些数据我们统称为 MetaData
- 也就是中文中的元数据

![](image/Pasted%20image%2020221022104016.png)

- Metadata: 描述“其他数据"而存储的信息
	- 比如说你查看这个目录下的文件，根本不需要读取文件真正的数据
	- Metadata 的访问常常多于内容的访问
- Metadata 和文件内容是存在一起还是分开？
	- 建议分开存放
	- 你可以将磁盘想象成一个超级大的数组
	- 那么对于机械硬盘来说，寻找数据是需要转动磁头的，要是数据过于分散，会导致数据读取效率过慢，所以是不能存放在一起，需要和元数据和文件分开存储，这样能提高用户体验
- 文件内容是分开存储的呢？还是连续存储的呢？
	- 如果是连续存储，那么在对文件进行修改的时候，就会出现问题，假如一个文件从 10KB 变到 100KB 这样就会侵占别的文件了，只能寻找合适大小的地方去存储，要是文件频繁修改，会造成很多磁盘浪费
	- 所以只能进行分开存储，将一个文件分成很多小片，存储在储存设备上
	- 通常一块的大小是 4KB
- 这就是我们在单机系统上存储文件的样子

![](image/Pasted%20image%2020221022154058.png)

## Interviewer: How to save a large file in one machine

- Is block size big enough? 
- 100T(多文件) 
- = $100*1000G$ 
- = $100*1000*1000M$
- = $100*1000*1000*1000K$
- = $100*1000*1000*1000block$

- 这样就有问题了，Block的数量太多了，每 4K 空间就要储存一个 Block
- 这样光是储存 Block 就要花掉很多的空间
- 你要如何改进这个文件系统
	- 一般我们遇到这种情况，就会将一个 Block 变成 64MB 的 Chunk
	- 比起缺点，优点更明显

![](image/Pasted%20image%2020221022154910.png)


## Interviewer: How to save extra-large file in several machine

- 这就涉及到多台服务器了，主服务器只负责储存必要的数据，真正的存储都落在从服务器上

![](image/Pasted%20image%2020221022155454.png)

- 每个chunk的Offset偏移量可以不存在master上面
- 这里就涉及到了一个优化的点，就是 Master 不需要存储每个文件在每台机器上具体的位置，只需要存储文件的Chunk在那个机器就行，由 Chunk Server 来存储 Chunk 的具体位置

![](image/Pasted%20image%2020221022163537.png)

- Master 存储10P 文件的metadata 需要多少容量?
	- 1 chunk = 64MB needs 64B.(经验值) 
	- $10P=16*10^6$ chunk needs 10 G

## Interviewer: How to write a file

- 一次写入
- 还是拆分成多份多次写入

### 一次 VS 多次

- 写入过程中出错了，那么需要重新写入，哪一种方法更好
	- 一次传输得重新传输整个文件，多次只用重新传一小份
- 如果是分成多份多次写入，那么每一份的大小
	- 文件本来是按照Chunk来存储的，所以传输单位也是Chunk

### 那每一个 chunk 是怎么写入 server 的

- 和 Master 沟通，再由 Master 写入 Chunk Server
- 还是由客户端直接发送给 Chunk Server

![](image/Pasted%20image%2020221023175029.png)

## 如果要修改文件如何解决

- 首先，用户修改了文件，这是一个很麻烦的事情，因为要去比对储存在服务器上的数据，但是这样很麻烦
- 你要解决很多问题
	- Chunk 变大了咋办
	- Chunk 变小了咋办
	- 在哪里修改了

- 但是我们想一下，我们提供的是储存服务，储存的文件基本都是一次存储，之后就全是读取了
- 我们就可以很直接简单粗暴，先删除文件，再将文件重新写入一份

## Interviewer: How to read a file?

### 一次读整个文件? 还是拆分成多份多次读入



# Scale

