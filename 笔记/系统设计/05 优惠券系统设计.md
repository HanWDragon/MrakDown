# Keywords

![](image/Pasted%20image%2020221011090328.png)

# Scenario 场景

设计一个优惠券系统 Coupon System

## 优惠券核心流程

![](image/Pasted%20image%2020221011161216.png)

## 需求拆解

![](image/Pasted%20image%2020221011161244.png)

# Service服务

- 了解优惠券系统 Coupon System 相关服务
- 优惠券系统设计难点

## 服务结构设计

- 触达服务就是像站内信，站内私聊这些

![](image/Pasted%20image%2020221011161333.png)

## 优惠券系统难点

![](image/Pasted%20image%2020221011161448.png)

# Storage存储

- 模型的设计
- 优惠券系统 Coupon System 模型定义
- 优惠券系统的难点精讲

## 重要概念

### 券批次(coupon_batch)(券模板)

- 指一批优惠券的抽象、模板，包含优惠券的大部分属性
- 例：商家创建了一批优惠券，共1000张
	- 使用时间为202011-11 00:00:00 ~ 2020-11-11 23:59:59
	- 规定只有化妆品类目商品才能使用，满100减50

![](image/Pasted%20image%2020221011162628.png)

### 券

- 发放到用户的一个实体，已与用户绑定
- 例：将某批次的优惠券中的一张发送给某个用户，此时优惠券属于用户。

### 规则

- 优惠券的使用有规则和条件限制
	- 比如满100减50券，需要达到门槛金额 100元才能使用

## 表单设计

### 券批次表 coupon_batch Table

| 字段 column | 类型 type | 解释 explain | 例子 example |
|    :----:  |  :----:   |   :----:    |    :----:   |
|  batch_id  | INTEGER   |   批次ID   |   1111  |
| batch_name  | VARCHAR  |  批次名称   |  “双十一发送券”  |
|coupon_name | VARCHAR  |  券名称   |  “劳斯莱斯5元代金券”  |
| rule_id  | INTEGER |  规则，外键  |  1010 |
|   total_count| INTEGER  |   总数量  | 10000 |
|   assign_count  |INTEGER  |  已发放券数量   |  5000 |
|   used_count | INTEGER |   已使用数量    | 2500|

### 规则表 rule Table

- 这里的 rule_content 就是具体的规则内容，我们采用的是 json 的格式进行存储，为什么要这么存储
	1. 如果你单独作为一个字段列出来，假如产品经理说，要设计新的规则，咋办，改数据库？
	2. 灵活性很高，可以方便修改，不必修改数据库

| 字段 column | 类型 type | 解释 explain | 例子 example |
|    :----:  |  :----:   |   :----:    |    :----:   |
|  rule_id  | INTEGER   |   规则id，自增   |   1010  |
| name  | VARCHAR  |  名称   | “满减规则”  |
|type | INTEGER  |  优惠券类型，0—满减、1—折扣   |  0  |
| rule_content  | BLOB |  规则内容|  '{  threshold: 100 // 使用门槛 amount: 10 // 优惠金额 ......}'|

#### 规则内容

- 规则是很多变的，很多时候真的没办法固定下来
	- 今天限制用户注册时间
	- 或者是新用户才能领取
	- 还有一些复杂的规则计算条件

```json
'{
	threshold: 5.01                         // 使用门槛
	amount: 5                               // 优惠金额
	use_range: 3                            // 使用范围，0—全场，1—商家，2—类别，3—商品
	commodity_id: 10
	receive_count: 1                        // 每个用户可以领取的数量
	is_mutex: true                          // 是否互斥，true 表示互斥，false 表示不互斥
	receive_started_at: 2020-11-1 00:08:00  // 领取开始时间
	receive_ended_at: 2020-11-6 00:08:00    // 领取结束时间
	use_started_at: 2020-11-1 00:00:00      // 使用开始时间
	use_ended_at: 2020-11-11 11:59:59       // 使用结束时间
}'
```

### 优惠券表 coupon Table

- 思考一下，为什么会有冻结状态

| 字段 column | 类型 type | 解释 explain | 例子 example |
|    :----:  |  :----:   |   :----:    |    :----:   |
| coupon_id | INTEGER   |券ID，主键| 66889|
| user_id  | INTEGER  |用户id|1001|
|batch_id | INTEGER  |批次ID|1111|
| status  | INTEGER |状态，0—未使用，1—已使用，2—已过期, 3—冻结|1|
|order_id|VARCHAR|对应订单ID|12168257647382907847|
|received_time|DATETIME|领取时间|2020-11-07 00:12:48|
|validate_time|DATETIME|有效日期|2020-11-18 00:01:48|
|used_time|DATETIME|使用时间|2020-11-11 00:01:48|

##  优惠券系统

### 建券

![](image/Pasted%20image%2020221011210719.png)

#### 新建规则

```sql
INSERT INTO rule (name, type, rule_content)
VALUES(“满减规则”, 0, '{
	threshold: 100 
	amount: 10 
	......
}');
```

#### 新建优惠券批次

```sql
INSERT INTO coupon_batch (coupon_name, rule_id, total_count )
VALUES(“劳斯莱斯5元代金券”, 1010, 10000);
```

### 发券

![](image/Pasted%20image%2020221011210737.png)


![](image/Pasted%20image%2020221011211027.png)

