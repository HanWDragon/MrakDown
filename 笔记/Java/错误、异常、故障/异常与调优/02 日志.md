# SLF4 和 JCL  如何绑定日志实现

## 市面上常见两类组合

- 第二个是 Spring 的默认实现

![](image/Pasted%20image%2020241213180947.png)

## JCL绑定日志实现（log4j2）

![](image/Pasted%20image%2020241213181449.png)
### 引入依赖

```xml
        <!-- commons-logging 与 log4j2 集成 -->
        <dependency>-->
            <groupId>commons-logging</groupId>-->
            <artifactId>commons-logging</artifactId>-->
            <version>1.2</version>-->
        </dependency>-->
        <dependency>-->
            <groupId>org.apache.logging.log4j</groupId>-->
            <artifactId>log4j-api</artifactId>-->
            <version>2.2</version>-->
        </dependency>-->
        <dependency>-->
            <groupId>org.apache.logging.log4j</groupId>-->
            <artifactId>log4j-core</artifactId>-->
            <version>2.2</version>-->
        </dependency>-->
        <dependency>-->
            <groupId>org.apache.logging.log4j</groupId>-->
            <artifactId>log4j-jcl</artifactId>-->
            <version>2.2</version>-->
        </dependency>-->

```

### JCL 先去获取 LogFactory

![](image/Pasted%20image%2020241213185311.png)

### LogFactory 获取 Log 的过程

![](image/Pasted%20image%2020241213194024.png)

## SLF4j 绑定日志实现（Logback）

![](image/Pasted%20image%2020241213194340.png)

### 依赖

```java
        <!-- slf4j 与 logback 集成 -->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-core</artifactId>
            <version>1.2.3</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.30</version>
        </dependency>
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>1.2.3</version>
        </dependency>
    </dependencies>
```

## 原理

![](image/Pasted%20image%2020241213194901.png)
# Log4J2

## 应用

![](image/Pasted%20image%2020241213201012.png)

## 核心概念

![](image/Pasted%20image%2020241213200312.png)

![](image/Pasted%20image%2020241213200846.png)

# LogBack

## 应用

![](image/Pasted%20image%2020241213201050.png)

## 如何工作

![](image/Pasted%20image%2020241213201820.png)

### 代码

```java
/**
 * <h1>动态构造 Logger 对象</h1>
 * */
@SuppressWarnings("all")
public class LogbackHolder {

    /**
     * <h2>根据名称获取 logger 实例</h2>
     * */
    public static Logger getLogger(String name) {

        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();
        // 如果没有创建 logger
        if (loggerContext.exists(name) == null) {
            // 自己动态构造 logger 对象
            return buildLogger(name);
        }

        return loggerContext.getLogger(name);
    }

    /**
     * <h2>动态构造 logger 实例</h2>
     * */
    private static Logger buildLogger(String name) {

        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();
        Logger logger = loggerContext.getLogger(name);

        // 配置 rollingFileAppender
        RollingFileAppender rollingFileAppender = new RollingFileAppender();
        rollingFileAppender.setName(name);
        rollingFileAppender.setContext(loggerContext);

        // 配置 rollingPolicy
        TimeBasedRollingPolicy rollingPolicy = new TimeBasedRollingPolicy();
        rollingPolicy.setFileNamePattern("/tmp/log/" + name + ".%d{yyyyMM}.log");
        rollingPolicy.setParent(rollingFileAppender);
        rollingPolicy.setContext(loggerContext);
        rollingPolicy.start();

        // 配置 encoder
        PatternLayoutEncoder encoder = new PatternLayoutEncoder();
        encoder.setCharset(StandardCharsets.UTF_8);
        encoder.setPattern("%msg%n");
        encoder.setContext(loggerContext);
        encoder.start();

        rollingFileAppender.setRollingPolicy(rollingPolicy);
        rollingFileAppender.setEncoder(encoder);
        rollingFileAppender.start();

        // 配置 logger
        logger.addAppender(rollingFileAppender);
        logger.setAdditive(false);
        logger.setLevel(Level.INFO);

        return logger;
    }

    public static void main(String[] args) {

        getLogger("qinyi").info("imooc qinyi use logback...");
    }
}
```

# 通过 Lombok 注解使用日志框架

## 准备

![](image/Pasted%20image%2020241213203154.png)

## 提供的注解

![](image/Pasted%20image%2020241213203228.png)

## 如何实现

![](image/Pasted%20image%2020241213203530.png)

## 优缺点

![](image/Pasted%20image%2020241213203617.png)

# 回顾

## 两类常见的日志门面

![](image/Pasted%20image%2020241213203918.png)
## 使用 Lombok 打日志

- 打出来的日志的名称

![](image/Pasted%20image%2020241213204010.png)

# 日志记录需要符合规范

## 工程选择的日志门面

![](image/Pasted%20image%2020241213204242.png)

## 选择合适的日志打印级别

### 代码

```java

/**
 * <h1>选择合适的日志打印级别</h1>
 * */
@Slf4j
@RestController
@RequestMapping("/select")
public class SelectLogLevel {

    /**
     * <h2>选择日志级别</h2>
     * */
    @PostMapping("/log/level")
    public Imoocer selectLogLevel(Imoocer imoocer) {

        // 1. 更加具体的调试信息, 例如调用了什么方法, 参数是什么, 可以使用 trace
        log.trace("call printSomething, with args: [{}], [{}]", null, null);
        printSomething(null, null);

        // 2. 在项目开发阶段, 调试程序的正确性, 可以使用 debug
        log.debug("coming in selectLogLevel with args: [{}]", imoocer);

        // 3. 正常的业务执行流程、系统的启动/关闭、需要做的审计等等都可以使用 info
        if (imoocer.getAge() > 19) {
            // 将来可以用于统计 age 大于 19 的请求
            log.info("imoocer age > 19: [{}]", imoocer.getAge());
        }

        // 4. 不是错误, 不会影响程序的正常执行, 但是并不建议这样做, 可以使用 warn
        try {
            callRemoteSystem();
        } catch (Exception ex) {
            log.warn("call remote system error: [{}]", System.currentTimeMillis());
        }

        // 5. 程序出现了某种错误, 需要介入处理
        try {
            // 读取 classpath 下的 error.txt 文件
            org.springframework.util.ResourceUtils.getFile("classpath:error.txt");
        } catch (FileNotFoundException ex) {
            log.error("error.txt is not exist");
            return null;
        }

        return imoocer;
    }

    private void printSomething(String x, String y) {
        // ...
    }

    private void callRemoteSystem() {
        // ...
    }
}

```

## 对日志合理性、正确性、必要性分析

![](image/Pasted%20image%2020241213211933.png)

## 让你的日志有意义且不冗余

![](image/Pasted%20image%2020241213212153.png)

### 代码

```java
/**
 * <h1>对日志合理性、正确性、必要性的分析</h1>
 * */
@Slf4j
@RestController
@RequestMapping("/make")
public class MakeYourLogBetter {

    /** 在 SomeConf 中定义的 */
    final RestTemplate restTemplate;

    public MakeYourLogBetter(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @PostMapping("/better/log")
    public Imoocer betterLog(List<Imoocer> imoocers) {

        // 1. HTTP 请求的入参和结果
        ResponseEntity<Imoocer> entity =
                restTemplate.getForEntity("www.imooc.com",
                        Imoocer.class, imoocers.get(0));
        // 也需要酌情考虑这里的可行性，如果入参和结果都很大，那么，只记录一些 “核心” 的信息就可以了
        log.info("call imooc website with args and response: [{}], [{}]",
                imoocers.get(0), entity.getBody());

        // 2. 程序异常的原因
        int num = 0;
        try {
            num = Integer.parseInt(imoocers.get(0).getName());
        } catch (IllegalArgumentException ex) {
            log.error("parse int value error for imooc(index 0) name: [{}]",
                    imoocers.get(0).getName());
            // ...
        }

        // 3. 远程接口调用（HTTP 或 RPC）情况 -- 与第一种类似, 不再重复举例子

        // 4. 特殊的条件分支
        num = statistics(imoocers);

        return null;
    }

    private int statistics(List<Imoocer> imoocers) {

        int greaterThan20k = 0;

        for (Imoocer imoocer : imoocers) {
            if (null != imoocer.getSalary() && imoocer.getSalary() >= 20000.0) {
                ++greaterThan20k;
                if (imoocer.getSalary() > 50000.0) {
                    log.info("imoocer salary greater than 50k: [{}]", imoocer);
                }
            }
        }

        return greaterThan20k;
    }
}

```

## 需要规避的日志打印过程

### 哪些场景不需要打日志

![](image/Pasted%20image%2020241213212738.png)

### 代码

```java
/**
 * <h1>需要规避的日志</h1>
 * */
@Slf4j
@RestController
@RequestMapping("/avoid")
public class NeedAvoidLog {

    @PostMapping("/log")
    public Imoocer avoidLog(List<Imoocer> imoocers) {

        // 1. 避免大数据量日志的打印
        log.info("args imoocer: [{}]", imoocers); // 这种方式并不好
        if (imoocers.size() > 10) {
            log.info("args imoocer count: [{}]", imoocers.size());
        }

        // 2. 避免在循环中打日志, 特别是大循环
        imoocers.forEach(i -> log.info("imoocer name is: [{}]", i.getName()));

        // 3. 不要打没有意义的日志
        File file = new File(imoocers.get(0).getName());
        if (!file.exists()) {
            log.warn("file does not exist!");   // 没有意义
            log.warn("file does not exist: [{}]", imoocers.get(0).getName());
        }

        // 4. 如果日志什么都说明不了, 修改或删除
        double sumSalary = 0.0;
        for (Imoocer imoocer : imoocers) {
            sumSalary += imoocer.getSalary();
        }

        log.info("all imoocers sum salary is: [{}], [{}]", imoocers.size(), sumSalary);

        return null;
    }
}

```

## 日志要能对业务逻辑进行解释

### 日志应该包含哪些内容

![](image/Pasted%20image%2020241213213701.png)
### 代码

```java
/**
 * <h1>日志需要能够对你的业务逻辑进行解释</h1>
 * */
@Slf4j
@RestController
@RequestMapping("/explain")
public class UseLogExplainLogic {

    private final RestTemplate restTemplate;
    private final ObjectMapper mapper;

    public UseLogExplainLogic(RestTemplate restTemplate, ObjectMapper mapper) {
        this.restTemplate = restTemplate;
        this.mapper = mapper;
    }

    @SneakyThrows
    @PostMapping("/logic")
    public Imoocer logic(List<Imoocer> imoocers) {

        // 1. 对请求参数进行记录, 方便对系统的调试
        if (imoocers.size() > 10) {
            log.debug("request coming in logic, args count: [{}], args: [{}]",
                    imoocers.size(), mapper.writeValueAsString(
                            imoocers.stream().map(Imoocer::getName).collect(Collectors.toList())
                    ));
        } else {
            log.debug("request coming in logic, args: [{}]",
                    mapper.writeValueAsString(imoocers));
        }

        List<Imoocer> validImoocers = new ArrayList<>(imoocers.size());
        for (int i = 0; i != imoocers.size(); ++i) {
            Imoocer cur = imoocers.get(i);
            if (null == cur || StringUtils.isBlank(cur.getName()) || cur.getAge() <= 0) {
                // 2. 使用 warn 记录下脏数据, 警告信息
                log.warn("args has some error: [index={}], [imoocer={}]",
                        i, mapper.writeValueAsString(cur));
                continue;
            }
            validImoocers.add(cur);
        }

        // 3. 发起 HTTP 请求
        ResponseEntity<Imoocer> entity = null;
        try {
            entity = restTemplate.getForEntity("www.imooc.com", Imoocer.class,
                    validImoocers);
            log.info("call imooc website with args and response: [count={}], [{}]",
                    validImoocers.size(), mapper.writeValueAsString(entity.getBody()));
        } catch (RestClientException ex) {
            log.error("....", ex);
//            throw new RuntimeException("call imooc website error", ex);
        }

        // 4. 远程过程调用
        callRemoteService(entity.getBody());
        log.trace("call remote service: [func={}], [args={}]", "callRemoteService",
                mapper.writeValueAsString(entity.getBody()));

        log.debug("response logic is: [{}]", mapper.writeValueAsString(entity.getBody()));
        return entity.getBody();
    }

    private void callRemoteService(Imoocer imoocer) {
        // ...
    }
}

```

## Logback 的 MDC 解析

### MDC 是什么

![](image/Pasted%20image%2020241213214408.png)

### 代码

```java
/**
 * <h1>MDC 的使用和源码解析</h1>
 * */
@Slf4j
public class UseMDC {

    // 使用 MDC 之前, 需要先去配置 %X{REQUEST_ID}
    private static final String FLAG = "REQUEST_ID";

    // -----------------------------------------------------------------------------------------------------------------
    // 第一个例子

    private static void mdc01() {

        MDC.put(FLAG, UUID.randomUUID().toString());
        log.info("log in mdc01");
        mdc02();

        log.info("MDC FLAG is: [{}]", MDC.get(FLAG));
        MDC.remove(FLAG);
        log.info("after remove MDC FLAG");

        // 我们没有使用 clear, 但是也能猜出来, 就是清除所有的 key
    }

    private static void mdc02() {

        log.info("log in mdc02");
    }

    // -----------------------------------------------------------------------------------------------------------------
    // 第二个例子, 多线程
    static class MyHandler extends Thread {

        private final String name;

        public MyHandler(String name) {
            this.name = name;
        }

        @Override
        public void run() {
            MDC.put(FLAG, UUID.randomUUID().toString());
            log.info("start to process: [{}]", this.name);

            try {
                Thread.sleep(1200);
            } catch (InterruptedException e) {
                log.info(e.getMessage());
            }

            log.info("done to process: [{}]", this.name);
            MDC.remove(FLAG);
        }
    }

    private void MultiThreadUseMdc() {

        new MyHandler("imooc").start();
        new MyHandler("qinyi").start();
    }


    public static void main(String[] args) {

//        mdc01();
        new UseMDC().MultiThreadUseMdc();
    }
}

```

### 用途

![](image/Pasted%20image%2020241213215450.png)

## 微服务下的分布式调用链追踪日志

### 微服务日志链路

![](image/Pasted%20image%2020241213215712.png)

### 代码

```java
@Configuration
public class SomeConf {

//    @Bean
//    public RestTemplate restTemplate() {
//        return new RestTemplate();
//    }

    private static final String FLAG = "REQUEST_ID";

    @Bean
    public RestTemplate restTemplate() {

        RestTemplate restTemplate = new RestTemplate();

        List<ClientHttpRequestInterceptor> list = new ArrayList<>();

        list.add(((request, body, execution) -> {
            String traceId = MDC.get(FLAG);
            if (StringUtils.isNotEmpty(traceId)) {
                request.getHeaders().add(FLAG, traceId);
            }
            return execution.execute(request, body);
        }));

        restTemplate.setInterceptors(list);

        return restTemplate;
    }
}

```

```java
/**
 * <h1>日志链路追踪案例</h1>
 * */
@Slf4j
@RestController
@RequestMapping("/trace")
public class TraceRequestController {

    private final RestTemplate restTemplate;

    public TraceRequestController(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    /**
     * 127.0.0.1:8000/api/trace/request
     * */
    @GetMapping("/request")
    public Imoocer request() {

        String url = "http://127.0.0.1:9527/api/display/controller?name=qinyi";
        log.info("send request to 9527, status code is: [{}]",
                restTemplate.getForEntity(url, Void.class).getStatusCodeValue());
        return new Imoocer("qinyi", 19);
    }
}

```

```java
@Slf4j
@Component
public class TraceIdInterceptor implements HandlerInterceptor {

    private static final String FLAG = "REQUEST_ID";

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,
                             Object handler) throws Exception {

        // 清理之前的请求 id
        MDC.clear();

        String traceId = request.getHeader(FLAG);

        if (StringUtils.isEmpty(traceId)) {
            if (null == MDC.get(FLAG)) {
                MDC.put(FLAG, UUID.randomUUID().toString());
            }
        } else {
            MDC.put(FLAG, traceId);
        }

        return true;
    }
}
```

```java
@Configuration
public class WebMvcConfig extends WebMvcConfigurationSupport {

    @Override
    protected void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new TraceIdInterceptor()).addPathPatterns("/**").order(0);
    }
}

```

## 总结

### 好的日志是

![](image/Pasted%20image%2020241213221151.png)

### 日志对业务逻辑进行解释

![](image/Pasted%20image%2020241213221234.png)

### MDC 与分布式调用日志

![](image/Pasted%20image%2020241213221328.png)