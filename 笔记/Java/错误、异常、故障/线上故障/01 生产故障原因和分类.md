# 故障分类

- **代码 bug**：上线代码逻辑有问题，遇到特殊情况下，发生故障的情况
- **操作不当**：线上配置或资源配置错误、操作不当，比如启动顺序不合理、初始化脚本不对、生产数据隔离混用等
- **系统级别软件 bug**：技术架构中使用到的任何 OS 、第三方类库、软件在特殊场景下，bug 被触发导致故障的情况
- **实发流量**：热点或突发流量并发，引发的瞬时流量超过日常峰值或倍增长，造成性能下降或功能不可用问题
- **资源使用不均**：整体容量配比合理并率不达标，但有些业务冗余不足，导致资源不能正常合理使用
- **容量预估不足**：对个别业务核心优化预估不足
- **网络类**：公网拥堵、丢包、专线、网络设备故障、IP 被攻击（包括 DNS 被攻击）、IP 被封、域名被封、网络软件 BUG、业务部门使用不当、末及扩内容等
- **安全类**：被攻击、漏洞利用等问题，均归为此类
- **局方故障**：ISP ，根域名服务，电力、空调、光缆等外部单位故障导致的问题
- **硬件故障**：任何硬件非人为原因损坏导致的故障均归为此类
- **第三方合作公司或接口故障**：项目依赖的第三方公司或接口故障


- 个人统计（未必准确），实际生产中，遇到的故障所占比例。

|               故障分类                | 比例 (%) |                                         示例                                         |
| :-------------------------------: | :----: | :--------------------------------------------------------------------------------: |
|             配置不当，操作不当             |   30   |           <p align="left">数据库新加字段，线上忘记添加；配置文件更改位不同步；操作不当（设计本身也可能不合理）</p>           |
|               代码bug               |   50   |          <p align="left">业务考虑不周全，未覆盖所有场景，测试不到位；代码质量或设计问题，各种异常等，包括异常处理</p>          |
| 突发流量+资源问题（包括使用不当，也包括软件特性原因不够深入理解） |   10   | <p align="left">跟场景有很大关系；电商领域的促销流量；内容网站的突发流量等；依赖的存储、网络、等自身波动异常等；慢sql，各种主从不一致等；</p> |
|           第三方合作公司或接口故障            |   8    |                                  依赖的接口有故障；微信认证失败等                                  |
|                其他                 |   2    |                                       硬件故障等                                        |

- 故障中 BUG 类型分布

```chart
type: bar
labels: [数据完整性,需求功能复用,用户体验,Random,产品定义,参数一致性,取参错误,数据正确性,页面异常,入参错误,埋点问题,功能遗漏,异常兼容,逻辑错误]
series:
- title: 发生比例
  data: [1,4,4,4,5,7,8,9,13,14,14,16,33,82]

```

# BUG 是可以完全避免的吗？

日常项目里中，站在开发者的角度：

- 大多数程序员会花费 70% - 80% 时间调试，而不是在写代码，因为现在有很好的工具能极大帮助程序员防止和解决错误 
- 另外重要部分是给代码写文档，现在的需求越来越复杂，依赖的外部条件，技术组件也是越来越多，很多 bug 在所难免。但也有一些 bug 是不能被原谅的，所以养成良好的开发习惯，很重要

**bug 起源**： 1945年9月9日，格蕾丝·赫柏 （Grace Murray Hopper） 使用的 Mark Ⅱ 出现故障，导致工作无法进行。经过了近一天的检查，格蕾丝找到了故障的原因：继电器中有一只死掉的蛾子。蛾子被夹了出来。后来，bug（小虫）和 debug（除虫）这两个本来普普通通的词汇成了计算机领域中特指莫明其妙的“错误”和“排除错误”的专用词汇而流传至今，而格蕾丝·赫柏也因此成了第一个发现 bug 的人

# 混沌工程简介

- 观念和思想来源于： 《**混沌工程**》

- 说起混沌工程一次，也许你听过阿里的红蓝军对抗

- 混沌工程是一种通过实验探究的方式来让我们理解系统行为的方法，就像科学家通过实验来研究物理和社会现象一样，混沌工程通过实验来了解特定的系统
- 如何使用混沌工程提高系统弹性呢？混沌工程通过设计和执行一系列实验，帮助我们发现系统中潜在的、可以导致灾难的或让我们的用户受损的脆弱环节，推动开发者主动解决这些环节存在的问题和现在各大公司主流的被动式故障响应流程相比，混沌工程向前迈进了一大步

**混沌工程解决的问题**

- 要设计良好的系统需要考虑很多因素，比如可靠性、安全性、可扩展性、可定制化、可伸缩性、可维护性、用户体验等。
- 为了更高效地支撑业务发展，越来越多的企业选择基于云服务或云原生理念来构建平台。采用新思路和新技术必然会带来系统架构和组织结构的变革，引入风险因素。
- 如何通过实验证明生产环境下的分布式系统在面对失控条件的时候依然具备较强的 “可观测性”和故障恢复能力呢？这就是混沌工程要解决的问题

**混沌工程和测试的区别**

- 混沌工程故障注入和故障测试在侧重点和工具集的使用上有些重叠 
- 举个例子，Netfix 的很多混沌工程实验的研究对象都是基于故障注入来引入的
- 混沌工程和其他测试方法的主要区别在于，混沌工程是发现新信息的实践过程，而故障注入则是基于一个特定的条件、变址的验证方法
- 混沌工程和故障注入本质上是思维方式上的不同。故障注入自先要知道会发生什么敌障，然后一个一个地注入，而在复杂分布式系统中，想要穷举所有可能的故障，本身就是奢望
- 混沌工程的思维方式是主动去找故障，是探索性的，你不知道摘掉一个节点、关掉一个服务会发生什么故障，虽然按计划做好了降级预案，但是关闭节点时却引发了上游服务异常，进而引发雪崩，这不是靠故障注入或预先计划能发现的

**一些混沌实验的输入样例**

- 模拟整个云服务区域或整个数据中心的故障
- 部分删除各种实例上的Kafka主题
- 重新创建生产中发生的问题
- 针对特定百分比的交易服务之间注入一段预期的访问延迟
- 基于函数的混乱（运行时注入）随机导致抛出异常的函数
- 代码插入，向目标程序添加指令和充许在某些指令之前进行故障注入
- 时间旅行：强制系统时钟彼此不同步
- 在模拟I/O错误的驱动程序代码中执行例程
- 在 Elasticsearch 集群上最大化CPU 
- 核心混沌工程实验的机会是无限的，可能会根据分布式系统的架构和组织的核心业务价值而有所不同

**混沌工程实现的四个步骤**

1. 定义并测量系统的**稳定状态**

- 首先精确定义指标，表明您的系统按照应有的方式运行。
- Netflix 使用客户点击视频流设备上播放按钮的点击作为指标，称为 “每秒流量”。请注意，这更像是商业指标而非技术指标；事实上，在混沌工程中，**业务指标**通常比技术指标更有用，因为它们更适合衡量用户体验或运营

 2. 创建假设，与任何实验一样，您需要一个假设来进行测试。
 
 - 因为你试图破坏系统正常运行时的稳定状态，你的假设将是这样的，“当我们做 X 时，这个系统的稳定状态应该没有变化。
 - 为什么用这种方式表达？如果你的期望是你的动作会破坏系统的稳定状态，那么你会做的第一件事会是修复问题
 - 混沌工程应该包括真实的实验，涉及真正的未知数 
 
 3. 模拟现实世界中可能发生的事情
 
 - 目前有如下混沌工程实践方法：模拟数据中心的故障、强制系统时钟不同步、在驱动程序代码中模拟 I/O 异常、模拟服务之间的延迟、随机引发函数抛异常。
 - 通常，您希望模拟可能导致系统不可用或导致其性能降低的场景。先考虑可能出现什么问题，然后进行模拟
 - 一定要优先考虑潜在的错误。当你拥有非常复杂的系统时，很容易引起出乎意料的下游效应，这是混沌工程寻找的结果之一
 - 因此，系统越复杂，越重要，它就越有可能成为混沌工程的候选对象。
 
 4. 证明或反驳你的假设
 
 - 将稳态指标与干抗注入系统后收集的指标进行比较。如果您发现测量结果存在差异，那么您的混沌工程实验已经成功-您现在可以继续加固系统，以便现实世界中的类似事件不会导致大问题。或者，如果您发现稳定状态可以保持，那么你对该系统的稳定性大可放心

**引入混沌工程的一些建议**

1. 引入混沌工程，需要建立进行面向失败设计 （可以使系统暴露出已有问题的设计）和拥抱失败的技术文化
2. 实施混沌工程，需要定义一个清晰可衡量的目标
3. 推广混沌工程，要在控制风险的前提下不断提升效率

**阿里巴巴混沌工程画像**

![](image/Pasted%20image%2020250104222050.png)

**混沌工程工具**

[chaosblade-io/ chaosblade](https://github.com/chaosblade-io/chaosblade)： An easy to use and powerful chaos engineering experiment toolkit. （阿里巴巴开源的一款简单易用、 功能强大的混沌实验注入工具） 

![](image/Pasted%20image%2020250104223750.png)