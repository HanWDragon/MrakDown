# Redis锁处理幂等性失效

## 代码演示

1. 对事务的理解使用有问题，幂等设计 bug（事务还没有提交就将锁释放，导致重复插入）
2. Redis 锁使用有问题
3. 如果去掉这个事务，代码反而没有问题，因为此时只有一个线程进入

```java
/**  
 * 接口需要幂等，此处身份证号不允许重复  
 *  
 * @param user  
 */  
@Override  
@Transactional(rollbackFor = Exception.class)  
public void addError(User user) {  
    log.info("add user params user:{}", JSON.toJSONString(user));  
    Assert.isTrue(StringUtils.isNotBlank(user.getIdCard()), "身份证号不允许null");  
    String key = "key";  
    RLock lock = redissonClient.getLock(key);  
    lock.lock();  
    try {  
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<User>()  
                .eq(User::getIdCard, user.getIdCard());  
        long count = userMapper.selectCount(wrapper);  
        if (count == 0) {  
            userMapper.insert(user);  
        }  
    } catch (Exception e) {  
        log.error("add user error", e);  
    } finally {  
        lock.unlock();  
    }  
}
```

## 扩展

### 事务在生产中常见错误

- 多线程中不可传播
- 多个方法内如果异常被捕获将要被标记为异常事务，不可以再次提交（虽然不影响数据，但是有报错信息）
- 事务过大，是否有必要拆解小事务（如何优化），拆解后一致性问题。

![](image/Pasted%20image%2020250106180723.png)

## 幂等性设计方法

