# 后台准备工作

- 再IDEA完成字体和自动编译和自动导入的步骤
- 使用maven来管理微服务项目
- 创建好会员模块后，再添加日志模块
	- 这里注意logback的配置文件优的名称是logback.xml有的是logback-spring.xml
- 这里设置路由路径是为了后续微服务做**路由转发**，将接口带/member的请求都转发到member模块 `server.servlet.context-path=/member`
- 在AOP中设置对应的切点，保护隐私和监听方法执行参数和执行时间
- 创建公共模块，记得resource目录下创建config目录放置配置文件，不然文件冲突，优先级比放在resource目录下低
- 再来创建网关模块，注意gateway并不需要依赖别的模块，gateway是基于netty开发的，不需要引入common模块，和web依赖
- 当生产发布时，只有gateway需要配置外网ip，其余模块只需要开放内网访问，保证应用安全
- 通过配置gateway的VM参数来让gateway来打印日志
- `-Dreactor.netty.http.server.accessLogEnabled=true`

# gateway模块的开发

- 在其中开发拦截请求
# member模块的开发

- 开发人员统计模块
- 开发注册模块
- 定义请求实体类和通用返回值类
- 增加统一异常处理，以及添加自己定义的异常类，以及不打印堆栈信息
- 添加校验框架
- 使用雪花算法生成成员ID，自增ID只适合于小型单体应用，不适合数据库，不适合分库分表
- UUID是无序的，一堆无序ID构建有序索引，性能有问题
- 添加注册&登录模块（后面自己添加发送短信的功能）
- 跨域是前后端不可避免的问题，我们在网关模块配置
- 需要注意前后端参数传递，到底是表单还是json
- 实现单点登录
	- 两种主要实现方案
	- redis + token（内部数据只是作为键来查询）
	- jwt（token有意义，是用户信息加密）这次开发使用这种
	- 但是jwt也存在问题就是
	- token被解密（加盐值，每个项目的盐值不能一样）
	- token被第三方使用（对用户的操作进行监控，风险账号限流）
- 完成乘车人增删改查，为后面的代码生成器做准备（了解前后端单表增删改查的开发）
	- 设计对应的表，在持久层添加对应的代码生成对应的代码
	- 在插入数据时有一些数据是存储在Token的，要是每次都解析token太麻烦了，于是就需要拦截当前登录用户的数据放在线程本地变量，在member模块都能拿到数据
	- 然后就是编写前端代码和对应接口
	- 完成对应的代码
- 完成火车基础数据管理功能：车站、车次、车厢、座位
	- 我们之前一直写的前端界面都是针对客户端开发的，我们要开发管理员模块



## 雪花算法

### 原理
![](image/Pasted%20image%2020230906120405.png)

### 使用需要解决的问题

#### 数据中心，机器ID如何设置

- 利用Redis自增序列
- 利用数据库，为每台机器分配workID，保存ID和机器IP的关系

#### 时钟回拔

- 机器时间是3点，但是北京时间是2点，如果把机器的时间往回拔，那么2～3点的ID会重复生成
- 直接使用备用服务器，等时间过去就好了，通常都会有运维来管理服务器时间，这个问题不大，一般服务器时间离标准时间差几毫秒都会造成业务事故

# 代码生成器

- 自制前后端代码生成器，快速开发
- 以乘车人增删改查为模板，自制单表管理前后端生成器
	- 生成controller、service、req、resp、enum.js
	- 了解freemarker
	- 学会写自己的生成器可用于导出复制excel、页面静态化等
- 由于只有generator模块需要这个于是只添加依赖到这个模块
- 我们要梳理一下文件顺序然后在开始书写
	- 首先是pom.xml，我们需要获取到需要读取的文件信息，因为我们可能有多个数据库对应着多个模块，所以需要知道读取的文件生成对应的模块
	- ![](image/Pasted%20image%2020231230130646.png)
	- 知道要读取对应的文件，就去读取对应持久层xml文件得到表名和实体名
	- ![](image/Pasted%20image%2020231230142155.png)
	- 得到了必要的参数，书写好了对应了ftl，就可以开始生成

# 数据库准备工作

- 本地数据库和云数据库都可以，但是推荐云数据库
- 重点：专库专用，忌用root（权限太大了，很容易操作到别的库）
- 新增数据库train，新增用户train，配置权限只能访问train数据库
- 再添加Mybatis和JBDC的依赖，并添加Mybatis配置文件
- 不建议使用plus，在流程中使用代码生成器，其实也没太大差别
- 开发规范，代码生成器生成的代码不可以修改，代码生成器只能生成单表的增删改查
- 如果需要书写自己的SQL，要写到自己定义的mapper，不能放到生成的mapper

# SQL表的介绍

- member 是注册用户信息记录表，可以为自己买票也可以为别人买票
```sql
drop table if exists `member`;
create table `member` (
  `id` bigint not null comment 'id',
  `mobile` varchar(11) comment '手机号',
  primary key (`id`),
  unique key `mobile_unique` (`mobile`)
) engine=innodb default charset=utf8mb4 comment='会员';
```

- passenger 是乘车人的信息，里面的枚举类型和自己实现的代码生成器有关，这个新增时间和修改时间是方便查看对应信息，还有datetime（3）是精确到毫秒
```sql
drop table if exists `passenger`;
create table `passenger` (
  `id` bigint not null comment 'id',
  `member_id` bigint not null comment '会员id',
  `name` varchar(20) not null comment '姓名',
  `id_card` varchar(18) not null comment '身份证',
  `type` char(1) not null comment '旅客类型|枚举[PassengerTypeEnum]',
  `create_time` datetime(3) comment '新增时间',
  `update_time` datetime(3) comment '修改时间',
  primary key (`id`),
  index `member_id_index` (`member_id`)
) engine=innodb default charset=utf8mb4 comment='乘车人';
```
# 前端准备工作以及搭建

## 搭建

- Vue CLI 5 + Vue 3 + Ant Design Vue 3